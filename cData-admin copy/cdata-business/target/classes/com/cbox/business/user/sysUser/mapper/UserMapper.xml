<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.cbox.business.user.sysUser.mapper.UserMapper">
	<!-- 查询对象 -->
	<sql id="selectVO">
		<![CDATA[
			select 	
				u.user_id, 
				u.dept_id, 
				u.nick_name, 
				u.user_name, 
				u.real_name,
				u.email, 
				u.avatar, 
				u.phonenumber, 
				u.password, 
				u.sex, 
				u.id_number,
				u.user_type,
				u.identity_type,
				u.status, 
				u.del_flag, 
				u.login_ip, 
				u.login_date, 
				u.create_by, 
				u.create_time, 
				u.remark, 
				d.dept_name, 
				d.leader 
			from sys_user u
			left join sys_dept d on u.dept_id = d.dept_id
			left join d_check_info c on c.check_type="user" and u.user_id=c.relation_id and c.rec_status='1'
		]]>
	</sql>

	<select id="listUser" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		<include refid="selectVO" />
		where u.del_flag = '0'
		<!-- 筛选 审核状态用户 0-待审核，1-正常，2-审核不通过 -->
		<if test="check_status != null and check_status !=''">
			and c.check_status = #{check_status}
		</if>
		<if test="status != null and status !=''">
			and u.status = #{status}
		</if>
		<if test="id_number != null and id_number !=''">
			and u.id_number = #{id_number}
		</if>
		<if test="identity_type != null and identity_type !=''">
			and u.identity_type = #{identity_type}
		</if>
		<if test="phonenumber != null and phonenumber !=''">
			and u.phonenumber = #{phonenumber}
		</if>
		<if test="user_type != null and user_type !=''">
			and u.user_type = #{user_type}
		</if>
		<if test="dept_id != null and dept_id !=''">
			and u.dept_id = #{dept_id}
		</if>
		<if test="nick_name != null and nick_name !=''">
			and u.nick_name=#{nick_name}
		</if>
		<if test="user_name != null and user_name !=''">
			and u.user_name=#{user_name}
		</if>
		<if test="real_name != null and real_name !=''">
			and u.real_name like concat('%',#{real_name},'%')
		</if>
	</select>

	<select id="getSysUser" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		<include refid="selectVO" />
		where u.del_flag = '0'
		<if test="user_name != null and user_name !=''">
			and u.user_name=#{user_name}
		</if>
		<if test="user_id != null and user_id !=''">
			and u.user_id=#{user_id}
		</if>
	</select>


	<!-- 查询单位是否有待审核的账号 -->
	<select id="getDeptUser" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		<include refid="selectVO" />
		where u.del_flag = '0'
		and u.dept_id=#{dept_id} and u.user_type='dept'
		and u.status='2'
	</select>

	<select id="getSysUserByPhone" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		<include refid="selectVO" />
		where u.del_flag = '0'
		and u.phonenumber=#{phonenumber}
	</select>

	<select id="identityTypeValue" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		select dict_label,dict_value from sys_dict_data where
		dict_type=#{dict_type}
	</select>

	<select id="listfilterUser" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		select
		u.user_id,
		u.dept_id,
		u.nick_name,
		u.user_name,
		u.real_name,
		u.email,
		u.avatar,
		u.phonenumber,
		u.password,
		u.sex,
		u.id_number,
		u.user_type,
		u.identity_type,
		u.status,
		u.del_flag,
		u.login_ip,
		u.login_date,
		u.create_by,
		u.create_time,
		u.remark
		from
		sys_user u
		where u.status='1' and u.dept_id=#{dept_id} and u.user_id
		not in
		(select
		f.user_id
		from d_user_family f
		where f.dept_id=#{dept_id})
	</select>

	<select id="listfilterOperateUser" parameterType="java.util.Map"
		resultType="java.util.HashMap">
		select
		u.user_id,
		u.dept_id,
		u.nick_name,
		u.user_name,
		u.real_name,
		u.email,
		u.avatar,
		u.phonenumber,
		u.password,
		u.sex,
		u.id_number,
		u.user_type,
		u.identity_type,
		u.status,
		u.del_flag,
		u.login_ip,
		u.login_date,
		u.create_by,
		u.create_time,
		u.remark
		from
		sys_user u
		where u.status='1' and u.user_type='app' and u.dept_id =
		#{dept_id} and
		u.user_id not in
		(select
		f.user_id
		from d_dept_admin f
		where f.dept_id=#{dept_id} and (f.status='0' or f.status='1'))
	</select>

	<update id="deleteDeptUser">
		update sys_user set del_flag='2' where
		dept_id=#{dept_id} and user_type='dept'
	</update>


</mapper>